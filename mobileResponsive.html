<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Based Dropout Prediction & Counseling System</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Tailwind's slate-50 */
        }
        /* Custom scrollbar for a better look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* --- Smoother animation for modals --- */
        .page-enter { opacity: 0; transform: scale(0.95); } /* For page content */
        .page-enter-active { opacity: 1; transform: scale(1); transition: all 0.2s ease-out; }
        
        /* New animation for a sober slide-down effect on modals */
        .modal-enter {
            opacity: 0;
            transform: translateY(-30px) scale(0.97);
        }
        .modal-enter-active {
            opacity: 1;
            transform: translateY(0) scale(1);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); /* Smooth easing */
        }
        .modal-leave-active { 
            opacity: 0; 
            transform: scale(0.95); 
            transition: all 0.2s ease-in; 
        }

        .stat-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }
        .nav-link-active { color: #2563eb; font-weight: 600; }

        /* --- STYLES FOR THE AUTHENTICATION MODAL (LOGIN & REGISTER) --- */
        #authModal, #feedbackModal {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, rgba(230, 241, 248, 0.9), rgba(240, 242, 245, 0.9));
            background-size: 200% 200%;
            animation: gradient-shift 10s ease infinite alternate;
            backdrop-filter: blur(5px);
        }

        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }
        
        .auth-container {
            background-color: #fff;
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 420px;
            text-align: center;
            transition: box-shadow 0.3s ease-in-out;
            position: relative; 
        }
        .auth-container:hover { box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15); }

        .auth-title { font-size: 2.2rem; font-weight: 600; color: #2c3e50; margin-bottom: 0.5rem; }
        .auth-subtitle { color: #7f8c8d; margin-bottom: 2rem; }

        .input-group { text-align: left; margin-bottom: 1.5rem; }
        
        .input-group label { display: block; font-size: 0.9rem; color: #555; margin-bottom: 0.5rem; font-weight: 600; }
        .input-group input, .input-group select, .input-group textarea { width: 100%; padding: 0.85rem; border: 1px solid #dfe6e9; border-radius: 8px; font-size: 1rem; box-sizing: border-box; transition: border-color 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease; }
        .input-group input:hover, .input-group select:hover, .input-group textarea:hover { transform: scale(1.02); border-color: #3498db; }
        .input-group input:focus, .input-group select:focus, .input-group textarea:focus { border-color: #3498db; outline: none; box-shadow: 0 0 8px rgba(52, 152, 219, 0.3); transform: scale(1.02); }

        .auth-btn { width: 100%; padding: 0.85rem; background-color: #3498db; color: #fff; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease; }
        .auth-btn:hover { background-color: #2980b9; transform: scale(1.02); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }

        .auth-tabs { display: flex; border-bottom: 1px solid #dfe6e9; margin-bottom: 1.5rem; }
        .auth-tab { flex: 1; padding: 0.75rem; text-align: center; cursor: pointer; color: #7f8c8d; font-weight: 600; border-bottom: 3px solid transparent; transition: all 0.2s ease-in-out; }
        .auth-tab.active { color: #3498db; border-bottom-color: #3498db; }

        /* --- CHATBOT WIDGET STYLES --- */
        #chatbot-widget {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: #007bff;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
            z-index: 999;
        }

        #chatbot-widget:hover {
            background-color: #0056b3;
            transform: scale(1.1);
        }

        /* --- CHATBOT PANEL STYLES --- */
        #chatbot-panel {
            position: fixed;
            bottom: 90px;
            right: 24px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            z-index: 1000;
            transition: opacity 0.3s, transform 0.3s, height 0.3s, max-height 0.3s;
            transform-origin: bottom right;
            overflow: hidden;
        }

        #chatbot-header {
            background-color: #007bff;
            color: white;
            padding: 12px;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
        }
        
        #chatbot-header h2 {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0;
        }

        #minimize-chatbot-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0;
        }

        #chat-messages {
            flex-grow: 1;
            padding: 16px;
            overflow-y: auto;
            font-size: 0.9rem;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chat-message { max-width: 80%; padding: 10px 14px; border-radius: 18px; word-wrap: break-word; }
        .user-message { background-color: #007bff; color: white; border-bottom-right-radius: 4px; align-self: flex-end; }
        .bot-message { background-color: #e9ecef; color: #343a40; border-bottom-left-radius: 4px; align-self: flex-start; }

        #chat-form { display: flex; padding: 12px; border-top: 1px solid #e0e0e0; }
        #chat-form input { flex-grow: 1; padding: 10px; border: 1px solid #ced4da; border-radius: 20px; margin-right: 8px; font-size: 0.9rem; }
        #chat-form button { background-color: #007bff; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* Styles for chatbot hidden/minimized states */
        .chatbot-hidden { opacity: 0; transform: scale(0.95); pointer-events: none; }
        
        #chatbot-panel.minimized {
            max-height: 48px; 
            height: 48px;
        }
        #chatbot-panel.minimized #chat-messages,
        #chatbot-panel.minimized #chat-form {
            display: none;
        }

        /* Review and Rating Styles */
        .star-rating {
            display: flex;
            flex-direction: row-reverse;
            justify-content: flex-start;
            gap: 4px;
        }
        .star-rating input[type="radio"] {
            display: none;
        }
        .star-rating label {
            color: #d1d5db; /* gray-300 */
            cursor: pointer;
            transition: color 0.2s;
        }
        .star-rating input[type="radio"]:checked ~ label,
        .star-rating:not(:checked) > label:hover,
        .star-rating:not(:checked) > label:hover ~ label {
            color: #f59e0b; /* amber-500 */
        }
    </style>
</head>
<body class="antialiased text-slate-700">

    <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-40 border-b border-slate-200">
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center gap-2">
                        <i class="ph-student text-3xl text-blue-600"></i>
                        <span class="font-bold text-xl text-slate-800">Insightify</span>
                    </div>
                    <div class="hidden md:block">
                        <div class="ml-10 flex items-baseline space-x-4">
                            <a href="#home" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-slate-600 hover:text-blue-600 nav-link-active" data-page="landingPage">Home</a>
                            <a href="#dashboard" id="dashboardNavLink" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-slate-600 hover:text-blue-600 hidden" data-page="dashboard">Dashboard</a>
                            <a href="#contact" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-slate-600 hover:text-blue-600" data-page="contactPage">Contact Us</a>
                            <a href="#" id="headerFeedbackBtn" class="px-3 py-2 rounded-md text-sm font-medium text-slate-600 hover:text-blue-600 cursor-pointer">Feedback</a>
                        </div>
                    </div>
                </div>
                <div class="hidden md:block">
                       <div class="flex items-center gap-6">
                            <div id="authButtons">
                                <button id="openAuthModalBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-blue-700 transition-colors">Login / Signup</button>
                            </div>
                            <div id="userProfile" class="hidden items-center gap-4">
                                <span class="text-sm font-medium text-slate-700">Welcome, <span id="usernameDisplay"></span>!</span>
                                <button id="logoutBtn" class="bg-slate-200 text-slate-800 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-slate-300 transition-colors">Logout</button>
                            </div>
                       </div>
                </div>
                <div class="-mr-2 flex md:hidden">
                    <button id="mobileMenuBtn" type="button" class="bg-slate-100 inline-flex items-center justify-center p-2 rounded-md text-slate-500 hover:text-slate-600 hover:bg-slate-200 focus:outline-none">
                        <i id="mobileMenuIcon" class="ph-list text-2xl"></i>
                    </button>
                </div>
            </div>
        </nav>
        <div id="mobileMenu" class="md:hidden hidden">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                <a href="#home" class="nav-link block px-3 py-2 rounded-md text-base font-medium text-slate-600 hover:text-blue-600 nav-link-active" data-page="landingPage">Home</a>
                <a href="#dashboard" id="dashboardNavLinkMobile" class="nav-link block px-3 py-2 rounded-md text-base font-medium text-slate-600 hover:text-blue-600 hidden" data-page="dashboard">Dashboard</a>
                <a href="#contact" class="nav-link block px-3 py-2 rounded-md text-base font-medium text-slate-600 hover:text-blue-600" data-page="contactPage">Contact Us</a>
                 <a href="#" id="headerFeedbackBtnMobile" class="block px-3 py-2 rounded-md text-base font-medium text-slate-600 hover:text-blue-600">Feedback</a>
                <div id="authButtonsMobile" class="border-t border-slate-200 mt-3 pt-3">
                    <button id="openAuthModalBtnMobile" class="w-full text-left bg-blue-600 text-white mt-2 px-3 py-2 rounded-lg text-base font-semibold hover:bg-blue-700 transition-colors">Login / Signup</button>
                </div>
                <div id="userProfileMobile" class="hidden border-t border-slate-200 mt-3 pt-3 px-2 space-y-2">
                    <p class="text-base font-medium text-slate-700">Welcome, <span id="usernameDisplayMobile"></span>!</p>
                    <button id="logoutBtnMobile" class="w-full text-left bg-slate-200 text-slate-800 px-3 py-2 rounded-lg text-base font-semibold hover:bg-slate-300 transition-colors">Logout</button>
                </div>
            </div>
        </div>
    </header>

    <main>
        <section id="landingPage" class="page-content">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16 sm:py-20 text-center">
                <h1 class="text-4xl sm:text-5xl lg:text-6xl font-extrabold text-slate-900 tracking-tight">
                    Unlock Student Potential, <span class="text-blue-600">Predict Success.</span>
                </h1>
                <p class="mt-6 max-w-3xl mx-auto text-lg text-slate-600">
                    Insightify is an AI-powered early warning system that helps educators identify at-risk students before it's too late. By consolidating data and providing clear, actionable insights, we empower mentors to intervene effectively and foster student success.
                </p>
                <div class="mt-8 flex flex-col sm:flex-row items-center justify-center gap-4">
                    <a href="#" id="dashboardActionBtn" class="w-full sm:w-auto bg-blue-600 text-white px-8 py-3 rounded-lg text-lg font-semibold hover:bg-blue-700 transition-colors">Go to Dashboard</a>
                    <a href="#contact" data-page="contactPage" class="nav-link w-full sm:w-auto bg-white text-slate-700 px-8 py-3 rounded-lg text-lg font-semibold border border-slate-300 hover:bg-slate-100 transition-colors">Contact Us</a>
                </div>
            </div>
        </section>

        <section id="teacherDashboardPage" class="page-content hidden">
             <div id="sidebarBackdrop" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden lg:hidden"></div>

            <div class="relative min-h-screen lg:flex">
                <aside id="dashboardSidebar" class="w-64 bg-white border-r border-slate-200 flex flex-col fixed inset-y-0 left-0 z-50 transform -translate-x-full transition-transform duration-300 ease-in-out lg:relative lg:translate-x-0">
                    <div class="h-16 flex items-center justify-center border-b border-slate-200 px-4">
                        <i class="ph-student text-3xl text-blue-600"></i>
                        <span class="font-bold text-xl text-slate-800 ml-2">Insightify</span>
                    </div>
                    <nav class="flex-1 px-4 py-6 space-y-2">
                        <a href="#" data-page="teacherDashboardPage" class="nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg text-slate-700 bg-blue-50 text-blue-600 font-semibold">
                            <i class="ph-layout text-xl"></i><span>Dashboard</span>
                        </a>
                        <a href="#" class="flex items-center gap-3 px-4 py-2.5 rounded-lg text-slate-600 hover:bg-slate-100">
                            <i class="ph-chart-bar text-xl"></i><span>Reports</span>
                        </a>
                        <a href="#" class="flex items-center gap-3 px-4 py-2.5 rounded-lg text-slate-600 hover:bg-slate-100">
                            <i class="ph-gear text-xl"></i><span>Settings</span>
                        </a>
                    </nav>
                    <div class="px-4 py-4 border-t border-slate-200">
                        <button id="logoutBtnSidebar" class="w-full flex items-center gap-3 px-4 py-2.5 rounded-lg text-slate-600 hover:bg-red-50 hover:text-red-600">
                            <i class="ph-sign-out text-xl"></i><span>Logout</span>
                        </button>
                    </div>
                </aside>
        
                <main class="flex-1 p-6 sm:p-8 overflow-y-auto bg-slate-50">
                    <header class="flex justify-between items-center mb-8">
                        <div class="flex items-center gap-4">
                             <button id="sidebarToggleBtn" class="lg:hidden p-2 rounded-md text-slate-500 hover:bg-slate-200">
                                <i class="ph-list text-2xl"></i>
                            </button>
                            <div>
                                <h1 class="text-2xl sm:text-3xl font-bold text-slate-800">Welcome back, <span id="dashboardUsername"></span>!</h1>
                                <p class="text-slate-500 mt-1 text-sm sm:text-base">Here's an overview of your students' performance.</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                             <img id="dashboardTeacherAvatar" src="" alt="Teacher Avatar" class="w-12 h-12 rounded-full object-cover border-2 border-white shadow-sm">
                        </div>
                    </header>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="stat-card bg-white p-6 rounded-xl border border-slate-200">
                            <div class="flex items-center justify-between">
                                <div><p class="text-sm font-medium text-slate-500">Total Students</p><p id="totalStudents" class="text-3xl font-bold text-slate-800">0</p></div>
                                <div class="p-3 bg-blue-100 rounded-full"><i class="ph-users-three text-2xl text-blue-500"></i></div>
                            </div>
                        </div>
                        <div class="stat-card bg-white p-6 rounded-xl border border-slate-200">
                            <div class="flex items-center justify-between">
                                <div><p class="text-sm font-medium text-slate-500">High Risk</p><p id="highRiskStudents" class="text-3xl font-bold text-red-500">0</p></div>
                                <div class="p-3 bg-red-100 rounded-full"><i class="ph-warning-octagon text-2xl text-red-500"></i></div>
                            </div>
                        </div>
                        <div class="stat-card bg-white p-6 rounded-xl border border-slate-200">
                            <div class="flex items-center justify-between">
                                <div><p class="text-sm font-medium text-slate-500">Moderate Risk</p><p id="moderateRiskStudents" class="text-3xl font-bold text-amber-500">0</p></div>
                                <div class="p-3 bg-amber-100 rounded-full"><i class="ph-warning text-2xl text-amber-500"></i></div>
                            </div>
                        </div>
                        <div class="stat-card bg-white p-6 rounded-xl border border-slate-200">
                            <div class="flex items-center justify-between">
                                <div><p class="text-sm font-medium text-slate-500">On Track</p><p id="onTrackStudents" class="text-3xl font-bold text-green-500">0</p></div>
                                <div class="p-3 bg-green-100 rounded-full"><i class="ph-check-circle text-2xl text-green-500"></i></div>
                            </div>
                        </div>
                    </div>
        
                    <div class="bg-white p-4 sm:p-6 rounded-xl border border-slate-200">
                        <h2 class="text-xl font-semibold text-slate-800 mb-4">Student Overview</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 p-4 bg-slate-50 rounded-lg">
                            <select id="streamFilter" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                            <select id="specializationFilter" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 hidden"></select>
                            <input id="searchInput" type="text" placeholder="Search by name..." class="w-full md:col-span-2 lg:col-auto px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <select id="riskFilter" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="all">All Risk Levels</option><option value="high">High Risk</option><option value="moderate">Moderate Risk</option><option value="low">On Track</option>
                            </select>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left min-w-[800px]">
                                <thead class="bg-slate-50 text-sm font-semibold text-slate-600">
                                    <tr><th class="p-4 rounded-l-lg">Student Name</th><th class="p-4">ID</th><th class="p-4">Risk Level</th><th class="p-4">Fee Status</th><th class="p-4">Attendance</th><th class="p-4">Avg. Score</th><th class="p-4 rounded-r-lg"></th></tr>
                                </thead>
                                <tbody id="studentTableBody" class="divide-y divide-slate-200"></tbody>
                            </table>
                        </div>
                    </div>
                </main>
            </div>
        </section>

        <section id="studentDashboardPage" class="page-content hidden">
             <div class="min-h-screen p-4 sm:p-6 lg:p-8">
                 <div class="max-w-7xl mx-auto">
                      <header class="mb-8">
                           <div>
                               <h1 class="text-3xl font-bold text-slate-800">My Dashboard</h1>
                               <p class="text-slate-500 mt-1">Your personal academic overview</p>
                           </div>
                      </header>
                      <div id="studentDataContainer">
                         </div>
                 </div>
             </div>
        </section>

        <section id="contactPage" class="page-content hidden">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
                <div class="text-center mb-12">
                     <h1 class="text-4xl font-extrabold text-slate-900 tracking-tight">Get in Touch</h1>
                     <p class="mt-4 max-w-2xl mx-auto text-lg text-slate-600">We'd love to hear from you. Whether you have a question about features, trials, or anything else, our team is ready to answer all your questions.</p>
                </div>
                <div class="bg-white p-8 rounded-2xl border border-slate-200 shadow-sm">
                    <form action="#" method="POST">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label for="first-name" class="block text-sm font-medium text-slate-700">First Name</label><input type="text" name="first-name" id="first-name" class="mt-1 block w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                            <div><label for="last-name" class="block text-sm font-medium text-slate-700">Last Name</label><input type="text" name="last-name" id="last-name" class="mt-1 block w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                            <div class="md:col-span-2"><label for="email" class="block text-sm font-medium text-slate-700">Email</label><input type="email" name="email" id="email" class="mt-1 block w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                            <div class="md:col-span-2"><label for="message" class="block text-sm font-medium text-slate-700">Message</label><textarea id="message" name="message" rows="4" class="mt-1 block w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea></div>
                        </div>
                        <div class="mt-6 text-right"><button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg text-sm font-semibold hover:bg-blue-700 transition-colors">Send Message</button></div>
                    </form>
                </div>
            </div>
        </section>
        
    </main>

    <div id="studentModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden"></div>
    
    <div id="authModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
         <div id="authModalContent" class="auth-container modal-enter">
              <button id="closeAuthModalBtn" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 p-1 rounded-full transition-colors">
                   <i class="ph-x text-2xl"></i>
              </button>
            
              <div class="auth-box">
                   <div class="auth-tabs">
                        <div class="auth-tab active" data-tab="login">Sign In</div>
                        <div class="auth-tab" data-tab="register">Create Account</div>
                   </div>

                   <div id="loginFormContainer">
                        <h1 class="auth-title">Welcome Back</h1>
                        <p class="auth-subtitle">Sign in to your account</p>
                        <form id="loginForm">
                             <div class="input-group">
                                 <label for="role">I am a...</label>
                                 <select id="role" name="role" required>
                                     <option value="" disabled selected>Select your role</option>
                                     <option value="student">Student</option>
                                     <option value="teacher">Teacher</option>
                                 </select>
                             </div>
                             <div class="input-group">
                                 <label for="username">Username</label>
                                 <input type="text" id="username" name="username" placeholder="Enter your username" required>
                             </div>
                             <div class="input-group">
                                 <label for="password">Password</label>
                                 <input type="password" id="password" name="password" placeholder="Enter your password" required>
                             </div>
                             <button type="submit" class="auth-btn">Login</button>
                        </form>
                   </div>

                   <div id="registerFormContainer" class="hidden">
                        <h1 class="auth-title">Create Account</h1>
                        <p class="auth-subtitle">Get started with a new account</p>
                         <form id="registerForm">
                             <div class="input-group">
                                 <label for="register-role">I am a...</label>
                                 <select id="register-role" name="register-role" required>
                                     <option value="" disabled selected>Select your role</option>
                                     <option value="student">Student</option>
                                     <option value="teacher">Teacher</option>
                                 </select>
                             </div>
                             <div class="input-group">
                                 <label for="register-username">Username</label>
                                 <input type="text" id="register-username" placeholder="Choose a username" required>
                             </div>
                             <div class="input-group">
                                 <label for="register-email">Email Address</label>
                                 <input type="email" id="register-email" placeholder="Enter your email" required>
                             </div>
                             <div class="input-group">
                                 <label for="register-password">Password</label>
                                 <input type="password" id="register-password" placeholder="Create a password" required>
                             </div>
                             <button type="submit" class="auth-btn" style="background-color: #4CAF50;">Sign Up</button>
                        </form>
                   </div>
              </div>
         </div>
    </div>

    <div id="feedbackModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div id="feedbackModalContent" class="auth-container modal-enter">
            <button id="closeFeedbackModalBtn" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 p-1 rounded-full transition-colors">
                <i class="ph-x text-2xl"></i>
            </button>
            <form id="headerFeedbackForm">
                <h1 class="auth-title">Give Feedback</h1>
                <p class="auth-subtitle">Help us improve the Insightify platform.</p>
                <div class="input-group">
                    <label>Your Rating</label>
                     <div class="star-rating !justify-center">
                         <input type="radio" id="hf-5-stars" name="header-rating" value="5" /><label for="hf-5-stars"><i class="ph-star-fill text-4xl"></i></label>
                         <input type="radio" id="hf-4-stars" name="header-rating" value="4" /><label for="hf-4-stars"><i class="ph-star-fill text-4xl"></i></label>
                         <input type="radio" id="hf-3-stars" name="header-rating" value="3" /><label for="hf-3-stars"><i class="ph-star-fill text-4xl"></i></label>
                         <input type="radio" id="hf-2-stars" name="header-rating" value="2" /><label for="hf-2-stars"><i class="ph-star-fill text-4xl"></i></label>
                         <input type="radio" id="hf-1-star" name="header-rating" value="1" /><label for="hf-1-star"><i class="ph-star-fill text-4xl"></i></label>
                    </div>
                </div>
                <div class="input-group">
                    <label for="headerReviewText">Your Comments</label>
                    <textarea id="headerReviewText" name="header-review" rows="4" placeholder="What do you like? What can be improved?"></textarea>
                </div>
                <button type="submit" class="auth-btn">Submit Feedback</button>
            </form>
        </div>
    </div>

    <div id="chatbot-widget">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M19 8H5C3.89543 8 3 8.89543 3 10V18C3 19.1046 3.89543 20 5 20H19C20.1046 20 21 19.1046 21 18V10C21 8.89543 20.1046 8 19 8Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M7 8V6C7 4.89543 7.89543 4 9 4H15C16.1046 4 17 4.89543 17 6V8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M15 14C15 14.5523 14.5523 15 14 15C13.4477 15 13 14.5523 13 14C13 13.4477 13.4477 13 14 13C14.5523 13 15 13.4477 15 14Z" fill="currentColor"/>
            <path d="M9 14C9 14.5523 8.55228 15 8 15C7.44772 15 7 14.5523 7 14C7 13.4477 7.44772 13 8 13C8.55228 13 9 13.4477 9 14Z" fill="currentColor"/>
        </svg>
    </div>

    <div id="chatbot-panel" class="chatbot-hidden w-[90vw] max-w-sm sm:w-full h-auto max-h-[70vh]">
        <header id="chatbot-header">
            <h2>Mitrr</h2> <button id="minimize-chatbot-btn"><i class="ph-minus text-xl"></i></button>
        </header>
        <div id="chat-messages">
             <div class="bot-message chat-message">
                 Hi there! I'm Mitrr, your personal AI assistant. How can I help you today?
             </div>
        </div>
        <form id="chat-form">
            <input type="text" id="chat-input" placeholder="Ask Mitrr anything..." autocomplete="off" required>
            <button type="submit"><i class="ph-paper-plane-tilt"></i></button>
        </form>
    </div>

    <script>
        let activeChart = null; // To hold the active chart instance

        // --- NEW & IMPROVED DATA SIMULATION ---
        const academicStructure = {
            "B.Tech / B.E.": ["Computer Science (CSE)", "AI & Machine Learning (AIML)", "Electronics & Comm. (ECE)"],
            "BBA": ["General Management", "Finance", "Marketing"],
            "BCA": ["General", "Data Science"],
        };
        const firstNames = ["Aarav", "Vivaan", "Aditya", "Vihaan", "Arjun", "Sai", "Reyansh", "Ayaan", "Krishna", "Ishaan", "Saanvi", "Aadhya", "Kiara", "Diya", "Pari", "Priyanshu"];
        const lastNames = ["Sharma", "Verma", "Gupta", "Singh", "Khan", "Rao", "Patel", "Kumar", "Das", "Reddy"];

        function generateMockStudents(count) {
            const students = [];
            for (let i = 1; i <= count; i++) {
                const stream = Object.keys(academicStructure)[Math.floor(Math.random() * Object.keys(academicStructure).length)];
                const specialization = academicStructure[stream][Math.floor(Math.random() * academicStructure[stream].length)];
                students.push({ 
                    id: `STU${String(i).padStart(3, '0')}`, 
                    name: `${firstNames[Math.floor(Math.random() * firstNames.length)]} ${lastNames[Math.floor(Math.random() * lastNames.length)]}`, 
                    stream: stream,
                    specialization: specialization,
                    attendance: Math.floor(Math.random() * 50) + 50, 
                    scores: Array.from({length: 5}, () => Math.floor(Math.random() * 60) + 40), 
                    subjects: [{ name: "Core Subject 1", attempts: Math.ceil(Math.random()*3) }, { name: "Core Subject 2", attempts: Math.ceil(Math.random()*2) }], 
                    feePaid: Math.random() > 0.15
                });
            }
            return students;
        }

        const mockStudents = generateMockStudents(250);
        let platformFeedback = [];

        function calculateRisk(student) { 
            let riskScore = 0; 
            let reasons = []; 
            if (student.attendance < 60) { 
                riskScore += 40; 
                reasons.push({ factor: "Critically Low Attendance", value: `${student.attendance}%`, severity: 'high' }); 
            } else if (student.attendance < 75) { 
                riskScore += 20; 
                reasons.push({ factor: "Low Attendance", value: `${student.attendance}%`, severity: 'moderate' }); 
            } 
            const scoreTrend = student.scores[student.scores.length - 1] - student.scores[0]; 
            if (scoreTrend < -15) { 
                riskScore += 35; 
                reasons.push({ factor: "Sharp Score Drop", value: `${scoreTrend} points`, severity: 'high' }); 
            } else if (scoreTrend < -5) { 
                riskScore += 15; 
                reasons.push({ factor: "Declining Scores", value: `${scoreTrend} points`, severity: 'moderate' }); 
            } 
            const highAttempts = student.subjects.find(s => s.attempts >= 3); 
            if (highAttempts) { 
                riskScore += 25; 
                reasons.push({ factor: "Multiple Attempts", value: `${highAttempts.name} (${highAttempts.attempts} attempts)`, severity: 'high' }); 
            } 
            if (!student.feePaid) { 
                riskScore += 15; // Increased risk weight for unpaid fees
                reasons.push({ factor: "Fee Payment Due", value: "Outstanding", severity: 'moderate' }); 
            } 
            let riskLevel = 'low'; 
            if (riskScore >= 60) { 
                riskLevel = 'high'; 
            } else if (riskScore >= 30) { 
                riskLevel = 'moderate'; 
            } 
            return { riskScore, riskLevel, reasons }; 
        }
        
        const studentsWithRisk = mockStudents.map(student => ({ ...student, ...calculateRisk(student), avgScore: Math.round(student.scores.reduce((a, b) => a + b, 0) / student.scores.length) }));
        
        // --- Global state for logged-in user ---
        let loggedInUser = null; 

        // --- DASHBOARD UI RENDERING ---
        function renderDashboardStats(studentList = studentsWithRisk) {
            document.getElementById('totalStudents').textContent = studentList.length;
            document.getElementById('highRiskStudents').textContent = studentList.filter(s => s.riskLevel === 'high').length;
            document.getElementById('moderateRiskStudents').textContent = studentList.filter(s => s.riskLevel === 'moderate').length;
            document.getElementById('onTrackStudents').textContent = studentList.filter(s => s.riskLevel === 'low').length;
        }

        function getRiskBadge(riskLevel) {
            const styles = { high: 'bg-red-100 text-red-700', moderate: 'bg-amber-100 text-amber-700', low: 'bg-green-100 text-green-700' };
            return `<span class="px-3 py-1 text-xs font-semibold rounded-full ${styles[riskLevel]}">${riskLevel.charAt(0).toUpperCase() + riskLevel.slice(1)} Risk</span>`;
        }
        
        let studentChart = null;
        function renderStudentDashboard(student) {
            const container = document.getElementById('studentDataContainer');
            if (!student) {
                container.innerHTML = `<p class="text-center text-slate-500">Could not find your data. Please contact support.</p>`;
                return;
            }
              const severityStyles = { high: { icon: '<i class="ph-fire-fill text-red-500"></i>', text: 'text-red-600' }, moderate: { icon: '<i class="ph-warning-fill text-amber-500"></i>', text: 'text-amber-600' }, low: { icon: '<i class="ph-check-circle-fill text-green-500"></i>', text: 'text-green-600' } };

            container.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 space-y-6">
                        <div class="bg-white p-6 rounded-xl border border-slate-200">
                            <div class="flex items-center gap-4">
                                <div class="p-3 bg-blue-100 rounded-full"><i class="ph-user text-3xl text-blue-500"></i></div>
                                <div>
                                    <h2 class="text-xl font-bold text-slate-800">${student.name}</h2>
                                    <p class="text-sm text-slate-500">${student.id}</p>
                                </div>
                            </div>
                        </div>
                         <div class="bg-white p-6 rounded-xl border border-slate-200">
                            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2"><i class="ph-activity"></i> Your Current Status</h3>
                            <div class="space-y-1 mb-4"><p class="font-medium">Overall Risk Level:</p>${getRiskBadge(student.riskLevel)}</div>
                            <p class="font-medium mb-3">Feedback:</p>
                            <ul class="space-y-3">${student.reasons.length > 0 ? student.reasons.map(reason => `<li class="flex items-start gap-3"><div class="mt-1">${severityStyles[reason.severity] ? severityStyles[reason.severity].icon : ''}</div><div><span class="font-semibold text-sm ${severityStyles[reason.severity] ? severityStyles[reason.severity].text : ''}">${reason.factor}</span><p class="text-xs text-slate-500">${reason.value}</p></div></li>`).join('') : '<li class="flex items-center gap-2 text-sm text-slate-500"><i class="ph-thumbs-up text-green-500"></i>No significant risk factors detected. Keep up the great work!</li>'}</ul>
                        </div>
                    </div>
                    <div class="lg:col-span-2 space-y-6">
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                             <div class="stat-card bg-white p-6 rounded-xl border border-slate-200">
                                <div class="flex items-center justify-between">
                                    <div><p class="text-sm font-medium text-slate-500">Your Attendance</p><p class="text-3xl font-bold text-slate-800">${student.attendance}%</p></div>
                                    <div class="p-3 bg-blue-100 rounded-full"><i class="ph-chart-bar text-2xl text-blue-500"></i></div>
                                </div>
                            </div>
                             <div class="stat-card bg-white p-6 rounded-xl border border-slate-200">
                                <div class="flex items-center justify-between">
                                    <div><p class="text-sm font-medium text-slate-500">Average Score</p><p class="text-3xl font-bold text-slate-800">${student.avgScore}%</p></div>
                                    <div class="p-3 bg-indigo-100 rounded-full"><i class="ph-graduation-cap text-2xl text-indigo-500"></i></div>
                                </div>
                            </div>
                            <div class="stat-card bg-white p-6 rounded-xl border border-slate-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-slate-500">Fee Status</p>
                                        ${student.feePaid 
                                            ? `<p class="text-3xl font-bold text-green-500">Paid</p>` 
                                            : `<p class="text-3xl font-bold text-red-500">Unpaid</p>`
                                        }
                                    </div>
                                    <div class="p-3 ${student.feePaid ? 'bg-green-100' : 'bg-red-100'} rounded-full">
                                        <i class="ph-money text-2xl ${student.feePaid ? 'text-green-500' : 'text-red-500'}"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                         <div class="bg-white p-6 rounded-xl border border-slate-200">
                            <h3 class="text-lg font-semibold mb-2">Your Performance Trend</h3>
                            <div class="h-64"><canvas id="studentPerformanceChart"></canvas></div>
                        </div>
                    </div>
                </div>
            `;
            const ctx = document.getElementById('studentPerformanceChart').getContext('2d');
            if (studentChart) { studentChart.destroy(); }
            studentChart = new Chart(ctx, { type: 'line', data: { labels: ['Test 1', 'Test 2', 'Test 3', 'Test 4', 'Test 5'], datasets: [{ label: 'Assessment Scores', data: student.scores, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', tension: 0.3, fill: true }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false, max: 100 } } } });
        }

        function renderStudentTable(filteredStudents = studentsWithRisk) {
            const tableBody = document.getElementById('studentTableBody');
            if(!tableBody) return;
            tableBody.innerHTML = filteredStudents.length === 0 
                ? `<tr><td colspan="7" class="text-center p-8 text-slate-500">No students found.</td></tr>`
                : filteredStudents.map(student => `
                <tr class="hover:bg-slate-50 cursor-pointer" onclick="openStudentModal('${student.id}')">
                    <td class="p-4 font-semibold text-slate-800">${student.name}</td>
                    <td class="p-4 text-slate-500">${student.id}</td>
                    <td class="p-4">${getRiskBadge(student.riskLevel)}</td>
                    <td class="p-4 font-medium">${student.feePaid ? `<span class="text-green-600">Paid</span>` : `<span class="text-red-600">Unpaid</span>`}</td>
                    <td class="p-4 font-medium">${student.attendance}%</td>
                    <td class="p-4 font-medium">${student.avgScore}%</td>
                    <td class="p-4 text-right"><button class="text-blue-600 hover:underline text-sm">Details</button></td>
                </tr>`).join('');
            renderDashboardStats(filteredStudents);
        }

        function openStudentModal(studentId) {
            const student = studentsWithRisk.find(s => s.id === studentId);
            if (!student) return;
            const modal = document.getElementById('studentModal');
            const severityStyles = { high: { icon: '<i class="ph-fire-fill text-red-500"></i>', text: 'text-red-600' }, moderate: { icon: '<i class="ph-warning-fill text-amber-500"></i>', text: 'text-amber-600' }, low: { icon: '<i class="ph-info-fill text-blue-500"></i>', text: 'text-blue-600' } };
            
            modal.innerHTML = `
                <div class="bg-white rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto shadow-2xl modal-enter" id="modalContent">
                    <div class="p-6 border-b border-slate-200 flex justify-between items-start">
                        <div><h2 class="text-2xl font-bold text-slate-800">${student.name}</h2><p class="text-slate-500">${student.id}</p></div>
                        <button onclick="closeStudentModal()" class="p-2 rounded-full hover:bg-slate-100"><i class="ph-x text-2xl"></i></button>
                    </div>
                    <div class="p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1 bg-slate-50 p-5 rounded-lg space-y-4">
                            <div>
                                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2"><i class="ph-activity"></i> Risk Analysis</h3>
                                <div class="space-y-1 mb-4"><p class="font-medium">Overall Risk Level:</p>${getRiskBadge(student.riskLevel)}</div>
                                <p class="font-medium mb-3">Contributing Factors:</p>
                                <ul class="space-y-3">${student.reasons.length > 0 ? student.reasons.map(reason => `<li class="flex items-start gap-3"><div class="mt-1">${severityStyles[reason.severity].icon}</div><div><span class="font-semibold text-sm ${severityStyles[reason.severity].text}">${reason.factor}</span><p class="text-xs text-slate-500">${reason.value}</p></div></li>`).join('') : '<li class="text-sm text-slate-500">No significant risk factors detected.</li>'}</ul>
                            </div>
                            <div class="border-t border-slate-200 pt-4">
                                 <h3 class="text-lg font-semibold mb-3 flex items-center gap-2"><i class="ph-money"></i> Financials</h3>
                                 <div class="flex items-center justify-between">
                                     <p class="font-medium">Fee Status:</p>
                                     ${student.feePaid 
                                         ? `<span class="px-3 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-700">Paid</span>` 
                                         : `<span class="px-3 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-700">Unpaid</span>`
                                     }
                                 </div>
                            </div>
                        </div>
                        <div class="lg:col-span-2 space-y-6">
                            <div><h3 class="text-lg font-semibold mb-2">Performance Trends</h3><div class="bg-white p-4 rounded-lg h-64 border border-slate-200"><canvas id="performanceChart"></canvas></div></div>
                            <div><h3 class="text-lg font-semibold mb-2">Intervention Hub</h3>
                                <div class="flex flex-wrap gap-3">
                                    <button class="flex items-center gap-2 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors text-sm"><i class="ph-paper-plane-tilt"></i> Send Email</button>
                                    <button class="flex items-center gap-2 bg-slate-600 text-white px-4 py-2 rounded-lg hover:bg-slate-700 transition-colors text-sm"><i class="ph-calendar-plus"></i> Schedule Meeting</button>
                                    <button class="flex items-center gap-2 bg-slate-200 text-slate-800 px-4 py-2 rounded-lg hover:bg-slate-300 transition-colors text-sm"><i class="ph-user-list"></i> Notify Guardian</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            modal.classList.remove('hidden');
            setTimeout(() => modal.querySelector('#modalContent').classList.add('modal-enter-active'), 10);
            const ctx = document.getElementById('performanceChart').getContext('2d');
            if (activeChart) { activeChart.destroy(); }
            activeChart = new Chart(ctx, { type: 'line', data: { labels: ['Test 1', 'Test 2', 'Test 3', 'Test 4', 'Test 5'], datasets: [{ label: 'Assessment Scores', data: student.scores, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', tension: 0.3, fill: true }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false, max: 100 } } } });
        }

        function closeStudentModal() {
            const modal = document.getElementById('studentModal');
            const modalContent = modal.querySelector('#modalContent');
            if (modalContent) {
                modalContent.classList.remove('modal-enter-active');
                modalContent.classList.add('modal-leave-active');
                setTimeout(() => { modal.classList.add('hidden'); modal.innerHTML = ''; }, 200);
            }
        }

        // --- CORE LOGIC FOR NAVIGATION AND STATE ---
        document.addEventListener('DOMContentLoaded', () => {
            const mainHeader = document.querySelector('header');
            const navLinks = document.querySelectorAll('.nav-link');
            const pages = document.querySelectorAll('.page-content');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const mobileMenuIcon = document.getElementById('mobileMenuIcon');
            const mobileMenu = document.getElementById('mobileMenu');
            const dashboardNavLink = document.getElementById('dashboardNavLink');
            const dashboardNavLinkMobile = document.getElementById('dashboardNavLinkMobile');
            const dashboardActionBtn = document.getElementById('dashboardActionBtn');

            // Responsive Dashboard Sidebar
            const dashboardSidebar = document.getElementById('dashboardSidebar');
            const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
            const sidebarBackdrop = document.getElementById('sidebarBackdrop');


            // Auth Modal vars
            const authModal = document.getElementById('authModal');
            const authModalContent = document.getElementById('authModalContent');
            const openAuthModalBtns = [document.getElementById('openAuthModalBtn'), document.getElementById('openAuthModalBtnMobile'), dashboardActionBtn];
            const closeAuthModalBtn = document.getElementById('closeAuthModalBtn');
            const authTabs = document.querySelectorAll('.auth-tab');
            const loginFormContainer = document.getElementById('loginFormContainer');
            const registerFormContainer = document.getElementById('registerFormContainer');
            
            // Profile/Logout vars
            const authButtons = [document.getElementById('authButtons'), document.getElementById('authButtonsMobile')];
            const userProfiles = [document.getElementById('userProfile'), document.getElementById('userProfileMobile')];
            const usernameDisplays = [document.getElementById('usernameDisplay'), document.getElementById('usernameDisplayMobile')];
            const logoutBtns = [document.getElementById('logoutBtn'), document.getElementById('logoutBtnMobile'), document.getElementById('logoutBtnSidebar')];
            
            // Universal Feedback Modal Vars
            const feedbackModal = document.getElementById('feedbackModal');
            const feedbackModalContent = document.getElementById('feedbackModalContent');
            const openFeedbackModalBtns = [document.getElementById('headerFeedbackBtn'), document.getElementById('headerFeedbackBtnMobile')];
            const closeFeedbackModalBtn = document.getElementById('closeFeedbackModalBtn');
            const headerFeedbackForm = document.getElementById('headerFeedbackForm');

            function switchPage(pageId) {
                pages.forEach(page => page.classList.add('hidden'));
                const newPage = document.getElementById(pageId);
                if(newPage) {
                    // Hide header for teacher dashboard, show for all others
                    if (pageId === 'teacherDashboardPage') {
                        mainHeader.classList.add('hidden');
                    } else {
                        mainHeader.classList.remove('hidden');
                    }

                    newPage.classList.remove('hidden');
                    newPage.classList.add('page-enter');
                    setTimeout(() => newPage.classList.add('page-enter-active'), 10);
                    setTimeout(() => newPage.classList.remove('page-enter', 'page-enter-active'), 210);
                }

                navLinks.forEach(link => {
                    link.classList.remove('nav-link-active', 'bg-blue-50', 'text-blue-600', 'font-semibold');
                    const isDashboardLink = link.dataset.page && link.dataset.page.includes('Dashboard');
                    if (link.dataset.page === pageId || (isDashboardLink && pageId.includes('Dashboard'))) {
                        link.classList.add('nav-link-active');
                        if (link.closest('aside')) { // If it's a sidebar link
                            link.classList.add('bg-blue-50', 'text-blue-600', 'font-semibold');
                        }
                    }
                });
                mobileMenu.classList.add('hidden');
                 mobileMenuIcon.classList.remove('ph-x');
                 mobileMenuIcon.classList.add('ph-list');
            }
            
            function updateUIForLogin() {
                authButtons.forEach(btn => btn.classList.add('hidden'));
                userProfiles.forEach(p => {
                    p.classList.remove('hidden');
                    p.classList.add('flex');
                });
                usernameDisplays.forEach(d => d.textContent = loggedInUser.username);
                dashboardNavLink.classList.remove('hidden');
                dashboardNavLinkMobile.classList.remove('hidden');
                const dashboardPage = loggedInUser.role === 'teacher' ? 'teacherDashboardPage' : 'studentDashboardPage';
                dashboardNavLink.dataset.page = dashboardPage;
                dashboardNavLinkMobile.dataset.page = dashboardPage;
                dashboardActionBtn.href = `#dashboard`;
                dashboardActionBtn.dataset.page = dashboardPage;
            }

            function updateUIForLogout() {
                authButtons.forEach(btn => btn.classList.remove('hidden'));
                userProfiles.forEach(p => {
                    p.classList.add('hidden');
                    p.classList.remove('flex');
                });
                dashboardNavLink.classList.add('hidden');
                dashboardNavLinkMobile.classList.add('hidden');
                dashboardActionBtn.href = "#"; // Prevent navigation
                dashboardActionBtn.dataset.page = "";
                mainHeader.classList.remove('hidden'); // Ensure header is visible on logout
            }

            function handleLogin(user) {
                loggedInUser = user;
                updateUIForLogin();
                closeAuthModal();
                if (user.role === 'teacher') {
                    document.getElementById('dashboardUsername').textContent = loggedInUser.username;
                    document.getElementById('dashboardTeacherAvatar').src = `https://placehold.co/48x48/E2E8F0/475569?text=${loggedInUser.username.charAt(0).toUpperCase()}`;
                    initializeFilters();
                    renderStudentTable();
                    switchPage('teacherDashboardPage');
                } else {
                    const studentData = studentsWithRisk.find(s => s.name.toLowerCase().startsWith(user.username.toLowerCase())); 
                    renderStudentDashboard(studentData); 
                    switchPage('studentDashboardPage');
                }
            }
            
            function handleLogout(){
                loggedInUser = null;
                updateUIForLogout();
                switchPage('landingPage');
            }

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    if(link.dataset.page) {
                       switchPage(link.dataset.page);
                    }
                });
            });

            function openAuthModal() {
                if (loggedInUser) return; // Don't open if logged in
                authModal.classList.remove('hidden');
                setTimeout(() => authModalContent.classList.add('modal-enter-active'), 10);
            }

            function closeAuthModal() {
                authModalContent.classList.remove('modal-enter-active');
                authModalContent.classList.add('modal-leave-active');
                setTimeout(() => {
                    authModal.classList.add('hidden');
                    authModalContent.classList.remove('modal-leave-active');
                }, 200);
            }
            
            // --- Feedback Modal Logic ---
            function openFeedbackModal() {
                feedbackModal.classList.remove('hidden');
                setTimeout(() => feedbackModalContent.classList.add('modal-enter-active'), 10);
            }
            
            function closeFeedbackModal() {
                feedbackModalContent.classList.remove('modal-enter-active');
                feedbackModalContent.classList.add('modal-leave-active');
                setTimeout(() => {
                    feedbackModal.classList.add('hidden');
                    feedbackModalContent.classList.remove('modal-leave-active');
                }, 200);
            }
            
            openFeedbackModalBtns.forEach(btn => btn.addEventListener('click', e => {
                e.preventDefault();
                openFeedbackModal();
            }));
            closeFeedbackModalBtn.addEventListener('click', closeFeedbackModal);
            feedbackModal.addEventListener('click', e => { if (e.target.id === 'feedbackModal') closeFeedbackModal(); });

            openAuthModalBtns.forEach(btn => btn.addEventListener('click', (e) => {
                 if (loggedInUser) {
                     const page = loggedInUser.role === 'teacher' ? 'teacherDashboardPage' : 'studentDashboardPage';
                     switchPage(page);
                 } else {
                     e.preventDefault();
                     openAuthModal();
                 }
            }));
            closeAuthModalBtn.addEventListener('click', closeAuthModal);
            logoutBtns.forEach(btn => btn.addEventListener('click', handleLogout));
            authModal.addEventListener('click', e => { if (e.target.id === 'authModal') closeAuthModal(); });

            authTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    authTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    if (tab.dataset.tab === 'login') {
                        loginFormContainer.classList.remove('hidden');
                        registerFormContainer.classList.add('hidden');
                    } else {
                        loginFormContainer.classList.add('hidden');
                        registerFormContainer.classList.remove('hidden');
                    }
                });
            });

            loginForm.addEventListener('submit', function(event) {
                event.preventDefault();
                const role = document.getElementById('role').value;
                if (!role) {
                    const roleSelect = document.getElementById('role');
                    roleSelect.focus(); roleSelect.style.borderColor = '#e74c3c';
                    setTimeout(() => { roleSelect.style.borderColor = '#dfe6e9'; }, 2000);
                    return;
                }
                const username = document.getElementById('username').value;
                handleLogin({ username, role });
            });

            registerForm.addEventListener('submit', function(event) {
                event.preventDefault();
                const role = document.getElementById('register-role').value;
                if (!role) {
                    const roleSelect = document.getElementById('register-role');
                    roleSelect.focus(); roleSelect.style.borderColor = '#e74c3c';
                    setTimeout(() => { roleSelect.style.borderColor = '#dfe6e9'; }, 2000);
                    return;
                }
                const username = document.getElementById('register-username').value;
                handleLogin({ username, role });
            });

            if (headerFeedbackForm) {
                headerFeedbackForm.addEventListener('submit', e => {
                    e.preventDefault();
                    if (!loggedInUser) {
                        alert('You must be logged in to submit feedback.');
                        openAuthModal();
                        return;
                    }
                    const formData = new FormData(headerFeedbackForm);
                    const rating = formData.get('header-rating');
                    const review = formData.get('header-review');

                    if (!rating) {
                        alert('Please select a star rating.');
                        return;
                    }

                    const newFeedback = {
                        author: loggedInUser.username,
                        role: loggedInUser.role,
                        rating: parseInt(rating, 10),
                        review: review,
                        timestamp: new Date()
                    };
                    platformFeedback.unshift(newFeedback);
                    console.log("New platform feedback submitted:", platformFeedback);
                    alert('Thank you for your feedback!');
                    headerFeedbackForm.reset();
                    closeFeedbackModal();
                });
            }
            
            mobileMenuBtn.addEventListener('click', () => {
                const isHidden = mobileMenu.classList.toggle('hidden');
                if (isHidden) {
                     mobileMenuIcon.classList.remove('ph-x');
                     mobileMenuIcon.classList.add('ph-list');
                } else {
                     mobileMenuIcon.classList.remove('ph-list');
                     mobileMenuIcon.classList.add('ph-x');
                }
            });

            // --- RESPONSIVE SIDEBAR LOGIC ---
            function openSidebar() {
                dashboardSidebar.classList.remove('-translate-x-full');
                sidebarBackdrop.classList.remove('hidden');
            }
            function closeSidebar() {
                dashboardSidebar.classList.add('-translate-x-full');
                sidebarBackdrop.classList.add('hidden');
            }
            if (sidebarToggleBtn) sidebarToggleBtn.addEventListener('click', openSidebar);
            if (sidebarBackdrop) sidebarBackdrop.addEventListener('click', closeSidebar);
            
            
            // --- DASHBOARD FILTER LOGIC ---
            const streamFilter = document.getElementById('streamFilter');
            const specializationFilter = document.getElementById('specializationFilter');
            const searchInput = document.getElementById('searchInput');
            const riskFilter = document.getElementById('riskFilter');

            function initializeFilters() {
                if (!streamFilter) return;
                streamFilter.innerHTML = `<option value="all">All Streams</option>`;
                Object.keys(academicStructure).forEach(stream => {
                    streamFilter.innerHTML += `<option value="${stream}">${stream}</option>`;
                });
            }

            function applyFilters() {
                if (!streamFilter) return;
                const streamValue = streamFilter.value;
                const specializationValue = specializationFilter.value;
                const searchTerm = searchInput.value.toLowerCase();
                const riskValue = riskFilter.value;

                let filtered = studentsWithRisk;

                if (streamValue !== 'all') {
                    filtered = filtered.filter(s => s.stream === streamValue);
                    if (specializationValue && specializationValue !== 'all') {
                        filtered = filtered.filter(s => s.specialization === specializationValue);
                    }
                }
                if (searchTerm) filtered = filtered.filter(s => s.name.toLowerCase().includes(searchTerm));
                if (riskValue !== 'all') filtered = filtered.filter(s => s.riskLevel === riskValue);
                
                renderStudentTable(filtered);
            }
            
            if(streamFilter) streamFilter.addEventListener('change', () => {
                const selectedStream = streamFilter.value;
                if (selectedStream !== 'all') {
                    specializationFilter.innerHTML = `<option value="all">All Specializations</option>`;
                    academicStructure[selectedStream].forEach(spec => {
                        specializationFilter.innerHTML += `<option value="${spec}">${spec}</option>`;
                    });
                    specializationFilter.classList.remove('hidden');
                } else {
                    specializationFilter.classList.add('hidden');
                }
                applyFilters();
            });

            if(specializationFilter) specializationFilter.addEventListener('change', applyFilters);
            if(riskFilter) riskFilter.addEventListener('change', applyFilters);
            if(searchInput) searchInput.addEventListener('input', applyFilters);

            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (!document.getElementById('studentModal').classList.contains('hidden')) { closeStudentModal(); }
                    if (!document.getElementById('authModal').classList.contains('hidden')) { closeAuthModal(); }
                    if (!document.getElementById('feedbackModal').classList.contains('hidden')) { closeFeedbackModal(); }
                }
            });
            
            document.getElementById('studentModal').addEventListener('click', (e) => { if (e.target.id === 'studentModal') closeStudentModal(); });

            const initialPage = window.location.hash.substring(1) || 'home';
            const pageIdMap = { home: 'landingPage', contact: 'contactPage' };
            switchPage(pageIdMap[initialPage] || 'landingPage');

            // --- CHATBOT SCRIPT ---
            const chatbotWidget = document.getElementById('chatbot-widget');
            const chatbotPanel = document.getElementById('chatbot-panel');
            const minimizeChatbotBtn = document.getElementById('minimize-chatbot-btn');
            const chatHeader = document.getElementById('chatbot-header');
            const chatMessagesContainer = document.getElementById('chat-messages');
            const chatForm = document.getElementById('chat-form');
            const chatInput = document.getElementById('chat-input');
            
            chatbotWidget.addEventListener('click', () => {
                chatbotPanel.classList.toggle('chatbot-hidden');
                if (!chatbotPanel.classList.contains('chatbot-hidden')) {
                    chatInput.focus();
                }
            });

            minimizeChatbotBtn.addEventListener('click', () => {
                chatbotPanel.classList.toggle('minimized');
            });

            let isDragging = false;
            let offsetX, offsetY;
            chatHeader.addEventListener('mousedown', (e) => {
                isDragging = true;
                offsetX = e.clientX - chatbotPanel.offsetLeft;
                offsetY = e.clientY - chatbotPanel.offsetTop;
                document.body.style.userSelect = 'none';
            });
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                let newX = e.clientX - offsetX;
                let newY = e.clientY - offsetY;
                const panelRect = chatbotPanel.getBoundingClientRect();
                if (newX < 0) newX = 0;
                if (newY < 0) newY = 0;
                if (newX + panelRect.width > window.innerWidth) newX = window.innerWidth - panelRect.width;
                if (newY + panelRect.height > window.innerHeight) newY = window.innerHeight - panelRect.height;
                chatbotPanel.style.left = `${newX}px`;
                chatbotPanel.style.top = `${newY}px`;
                chatbotPanel.style.bottom = 'auto';
                chatbotPanel.style.right = 'auto';
            });
            document.addEventListener('mouseup', () => {
                isDragging = false;
                document.body.style.userSelect = 'auto';
            });

            chatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const userMessage = chatInput.value.trim();
                if (!userMessage) return;
                addChatMessage('user', userMessage);
                chatInput.value = "";
                const typingIndicator = addChatMessage('bot', "Typing...");
                const botMessage = await getChatResponse(userMessage);
                typingIndicator.remove();
                addChatMessage('bot', botMessage);
            });

            function addChatMessage(sender, text) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${sender}-message`;
                messageDiv.textContent = text;
                chatMessagesContainer.appendChild(messageDiv);
                chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
                return messageDiv;
            }

            async function getChatResponse(prompt) {
                const apiKey = ""; // Leave empty for automated key injection
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
                const systemPrompt = "You are Mitrr, a friendly and helpful AI assistant for students and mentors using the Insightify platform. Your goal is to provide supportive and concise answers related to academics, time management, and well-being. Do not answer questions outside of this scope.";
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: systemPrompt + "\n\nUser: " + prompt }] }] })
                    });
                     if (!response.ok) {
                         throw new Error(`API request failed with status ${response.status}`);
                    }
                    const result = await response.json();
                    return result.candidates?.[0]?.content?.parts?.[0]?.text.trim() || "I'm sorry, I couldn't process that. Please try again.";
                } catch (error) {
                    console.error("Error connecting to Gemini API:", error);
                    return "Sorry, I'm having trouble connecting right now. Please try again later.";
                }
            }
        });
    </script>

</body>
</html>